version: '3.8'

services:
  wireguard:
    image: linuxserver/wireguard:latest
    container_name: vpn-wireguard
    cap_add:
      - NET_ADMIN
      - SYS_MODULE
    environment:
      - PUID=1000
      - PGID=1000
      - TZ=Asia/Kolkata
      - SERVERURL=auto
      - SERVERPORT=51820
      - PEERS=10
      - PEERDNS=1.1.1.1
      - INTERNAL_SUBNET=10.13.13.0
    volumes:
      - ./wireguard:/config
      - /lib/modules:/lib/modules:ro
    ports:
      - "51820:51820/udp"
    sysctls:
      - net.ipv4.conf.all.src_valid_mark=1
      - net.ipv4.ip_forward=1
    restart: unless-stopped
    networks:
      - vpn_network

  db:
    image: mariadb:10.6
    container_name: vpn-database
    environment:
      MYSQL_ROOT_PASSWORD: root_secure_pass_123
      MYSQL_DATABASE: vpn_users
      MYSQL_USER: vpn_api
      MYSQL_PASSWORD: vpn_api_pass_456
    volumes:
      - db_data:/var/lib/mysql
      - ./db/init.sql:/docker-entrypoint-initdb.d/init.sql
    ports:
      - "3306:3306"
    restart: unless-stopped
    networks:
      - vpn_network

  squid:
    build: ./squid
    container_name: vpn-proxy
    volumes:
      - ./squid/squid.conf:/etc/squid/squid.conf:ro
      - ./squid/blocked.html:/var/www/html/blocked.html:ro
    ports:
      - "3128:3128"
    restart: unless-stopped
    networks:
      - vpn_network

  webui:
    build: ./webui
    container_name: vpn-webui-api
    environment:
      DB_HOST: db
      DB_USER: vpn_api
      DB_PASSWORD: vpn_api_pass_456
      DB_NAME: vpn_users
      SECRET_KEY: change_this_secret_key_in_production_xyz789
      WIREGUARD_HOST: wireguard
      WIREGUARD_PUBLIC_KEY: ${WIREGUARD_PUBLIC_KEY:-SERVER_PUBLIC_KEY_HERE}
      SERVER_ENDPOINT: ${SERVER_ENDPOINT:-YOUR_SERVER_IP:51820}
    ports:
      - "5000:5000"
    depends_on:
      - db
      - wireguard
    restart: unless-stopped
    networks:
      - vpn_network

  nginx:
    image: nginx:alpine
    container_name: vpn-nginx
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./certs:/etc/nginx/certs:ro
      - ./nginx/restricted.html:/usr/share/nginx/html/restricted.html:ro
      - ./webui/static:/usr/share/nginx/html/static:ro
    ports:
      - "80:80"
      - "443:443"
    depends_on:
      - webui
    restart: unless-stopped
    networks:
      - vpn_network

  restriction-server:
    image: nginx:alpine
    container_name: restriction-page-server
    volumes:
      - ./nginx/restricted.html:/usr/share/nginx/html/index.html:ro
    ports:
      - "8080:80"
    restart: unless-stopped
    networks:
      - vpn_network

volumes:
  db_data:

networks:
  vpn_network:
    driver: bridge
