{% extends "base.html" %}

{% block title %}Dashboard - VPN Cloud{% endblock %}

{% block content %}
<div class="dashboard-container">
    <div class="dashboard-header">
        <h1>VPN Dashboard</h1>
        <p>Manage your VPN connection and configuration</p>
    </div>

    <div class="stats-grid">
        <div class="stat-card">
            <div class="stat-icon">üë•</div>
            <div class="stat-info">
                <h3 id="totalUsers">-</h3>
                <p>Total Users</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">üîó</div>
            <div class="stat-info">
                <h3 id="activeConnections">-</h3>
                <p>Active Connections</p>
            </div>
        </div>

        <div class="stat-card">
            <div class="stat-icon">‚úÖ</div>
            <div class="stat-info">
                <h3 id="serverStatus">-</h3>
                <p>Server Status</p>
            </div>
        </div>
    </div>

    <div class="action-grid">
        <div class="action-card">
            <h2>Generate VPN Configuration</h2>
            <p>Download your personalized WireGuard configuration file</p>
            <button onclick="generateConfig()" class="btn-primary">Generate Config</button>
            <div id="config-result" class="result-box hidden"></div>
        </div>

        <div class="action-card">
            <h2>Access Policy</h2>
            <p>This VPN only allows access to:</p>
            <ul class="policy-list">
                <li>‚úÖ YouTube (youtube.com)</li>
                <li>‚úÖ YouTube Videos (googlevideo.com)</li>
                <li>‚úÖ YouTube Images (ytimg.com)</li>
                <li>‚ùå All other websites (blocked)</li>
            </ul>
        </div>
    </div>

    <div class="info-section">
        <h2>Quick Setup Guide</h2>
        <ol>
            <li>Click "Generate Config" to create your VPN configuration</li>
            <li>Save the configuration file to your device</li>
            <li>Import the configuration into WireGuard client</li>
            <li>Connect and enjoy YouTube-only access!</li>
        </ol>
    </div>
</div>

<script>
let latestConfig = null;

async function loadStatus() {
    try {
        const response = await fetch('/api/status');
        const data = await response.json();

        if (data.success) {
            document.getElementById('totalUsers').textContent = data.total_users;
            document.getElementById('activeConnections').textContent = data.active_connections;
            document.getElementById('serverStatus').textContent = data.status.toUpperCase();
        }
    } catch (error) {
        console.error('Failed to load status:', error);
    }
}

async function generateConfig() {
    const resultDiv = document.getElementById('config-result');
    resultDiv.innerHTML = '<p>Generating configuration...</p>';
    resultDiv.classList.remove('hidden');

    try {
        const response = await fetch('/api/config/generate', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            }
        });

        const data = await response.json();

        if (response.ok) {
            latestConfig = data.config;

            resultDiv.innerHTML = `
                <h3>Configuration Generated!</h3>
                <p>Assigned IP: ${data.assigned_ip}</p>
                <pre>${data.config}</pre>
                <p><strong>Quick Connect Downloads:</strong></p>
                <button onclick="downloadConfigFile()" class="btn-secondary">Download wg0.conf</button>
                <button onclick="downloadLinuxAutoConnect()" class="btn-secondary">Download Linux Auto-Connect Script</button>
                <button onclick="downloadWindowsAutoConnect()" class="btn-secondary">Download Windows Auto-Connect Script</button>
                <p><small>Note: Browsers cannot directly create system VPN tunnels. Use one of the downloaded scripts for near-automatic connection.</small></p>
            `;
        } else {
            resultDiv.innerHTML = `<p class="error">${data.error}</p>`;
        }
    } catch (error) {
        resultDiv.innerHTML = '<p class="error">Failed to generate configuration</p>';
    }
}

function downloadFile(content, filename, type = 'text/plain') {
    const blob = new Blob([content], { type });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = filename;
    a.click();
    window.URL.revokeObjectURL(url);
}

function downloadConfigFile() {
    if (!latestConfig) return;
    downloadFile(latestConfig, 'wg0.conf');
}

function downloadLinuxAutoConnect() {
    if (!latestConfig) return;

    const script = `#!/usr/bin/env bash
set -e

if ! command -v wg-quick >/dev/null 2>&1; then
  echo "wireguard-tools is not installed. Install it first: sudo apt install wireguard-tools"
  exit 1
fi

TMP_CONF="/tmp/wg0.conf"

cat > "$TMP_CONF" <<'WGCONF'
${latestConfig}
WGCONF

sudo mkdir -p /etc/wireguard
sudo cp "$TMP_CONF" /etc/wireguard/wg0.conf
sudo chmod 600 /etc/wireguard/wg0.conf
sudo wg-quick down wg0 >/dev/null 2>&1 || true
sudo wg-quick up wg0

echo "VPN connected. To disconnect: sudo wg-quick down wg0"
`;

    downloadFile(script, 'connect-linux.sh');
}

function downloadWindowsAutoConnect() {
    if (!latestConfig) return;

    const script = `# Run this script in PowerShell as Administrator
$ErrorActionPreference = 'Stop'

$configPath = Join-Path $env:TEMP 'wg0.conf'
@'
${latestConfig}
'@ | Set-Content -Path $configPath -Encoding ascii

$wgExe = "C:\\Program Files\\WireGuard\\wireguard.exe"
if (-not (Test-Path $wgExe)) {
    Write-Host "WireGuard is not installed. Download and install from: https://www.wireguard.com/install/"
    Write-Host "Your config is saved at: $configPath"
    exit 1
}

& $wgExe /uninstalltunnelservice wg0 2>$null
& $wgExe /installtunnelservice $configPath

Write-Host "VPN connected. To disconnect: & '$wgExe' /uninstalltunnelservice wg0"
`;

    downloadFile(script, 'connect-windows.ps1');
}

// Load status on page load
loadStatus();
setInterval(loadStatus, 10000); // Refresh every 10 seconds
</script>
{% endblock %}
